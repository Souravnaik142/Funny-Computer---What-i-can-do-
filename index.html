<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Riddle Drag & Tap ‚Äî Kids Game (Updated)</title>
  <style>
    :root{
      --bg1:#ff9a9e; --bg2:#fad0c4; --accent1:#43e97b; --accent2:#38f9d7; --card:#fff; --muted:#f0f0f0;
      --shadow:0 8px 24px rgba(0,0,0,0.15);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family: 'Comic Sans MS', cursive, sans-serif; background:linear-gradient(135deg,var(--bg1),var(--bg2)); min-height:100vh; margin:0; display:flex; align-items:center; justify-content:center; padding:28px;}
    .app{width:100%; max-width:980px;}
    .topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px}
    .logo{font-size:1.4rem; color:#fff; font-weight:700; text-shadow:1px 1px 4px rgba(0,0,0,0.4)}
    .musicBtn{background:transparent; border:none; font-size:28px; cursor:pointer; color:#fff; padding:6px 10px}
    .card {background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9)); border-radius: 20px; padding: 28px; box-shadow: var(--shadow); min-height: 480px;}
    #startScreen{display:flex; gap:18px; align-items:center; justify-content:center; flex-direction:column; padding:18px}
    #playerName{font-size:18px; padding:12px 16px; border-radius:24px; border:none; width:260px}
    .startBtn{background:linear-gradient(45deg,var(--accent1),var(--accent2)); color:#fff; padding:12px 20px; border-radius:24px; font-size:16px; border:none; cursor:pointer}
    #categoryScreen{display:none; padding:12px}
    .categoryGrid{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px}
    .catCard{background:var(--card); padding:12px; border-radius:14px; text-align:center; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .catCard h3{margin:8px 0 4px}
    .catCard p{margin:0; font-size:13px; color:#666}
    #gameArea{display:none}
    .riddleBar{display:flex; align-items:center; justify-content:space-between}
    #riddle{font-size:22px; padding:18px; border-radius:20px; background:linear-gradient(90deg,#fff3b0,#fff7e1); flex:1; margin-right:12px; min-height:70px}
    .meta{min-width:180px; text-align:right}
    .progress{height:14px; background:#eee; border-radius:99px; overflow:hidden; margin-top:8px}
    .progress > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#ff6a00,#ee0979); transition:width .6s ease}
    #progressLabel{font-size:12px;color:#333;margin-top:4px}
    #playerLabel{font-size:12px;color:#444;margin-top:8px}
    #answerSlots{display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:18px 0}
    .slot{min-width:46px; height:46px; display:inline-flex; align-items:center; justify-content:center; border-radius:12px; background:#f0f8ff; font-weight:700; font-size:18px; border-bottom:3px solid #000; user-select:none; cursor:pointer}
    .gap{width:20px}
    #letters{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
    .tile{padding:12px 14px; border-radius:12px; cursor:pointer; user-select:none; font-weight:800; font-size:18px; box-shadow:0 6px 18px rgba(0,0,0,0.12); transition:transform .12s ease}
    .tile:active{transform:scale(.98)}
    .tile[role=button]{outline:none}
    #controls{display:flex; gap:8px; justify-content:center; margin-top:12px}
    #controls button{padding:10px 14px; border-radius:12px; border:none; cursor:pointer; background:linear-gradient(45deg,var(--accent1),var(--accent2)); color:#fff}
    #feedback{font-size:20px; text-align:center; margin-top:10px; min-height:28px}
    #report{display:none; padding:14px}
    #report table{width:100%; border-collapse:collapse}
    #report th, #report td{padding:8px; border:1px solid #ddd}
    .medal{font-size:36px}
    #leaderboard{display:none; margin-top:12px}
    #lbTable{width:100%; border-collapse:collapse}
    #lbTable th,#lbTable td{padding:8px;border:1px solid #ddd;text-align:left}
    .small{font-size:13px;color:#666}
    .controls-row{display:flex; gap:8px; align-items:center; justify-content:center}
    @media (max-width:520px){ .riddleBar{flex-direction:column; align-items:flex-start} .meta{text-align:left; min-width:unset; margin-top:8px} }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="logo">Riddle Drag & Tap</div>
      <button id="musicBtn" class="musicBtn" title="Toggle music">üéµ</button>
    </div>

    <div class="card">
      <!-- Start Screen -->
      <div id="startScreen">
        <h1 style="margin:0;color:#333">Welcome!</h1>
        <div style="font-size:15px;color:#555">Enter your name to begin</div>
        <input id="playerName" placeholder="Your name" aria-label="Player name" />
        <div style="display:flex; gap:12px; align-items:center; flex-direction:column">
          <div class="controls-row">
            <button id="startBtn" class="startBtn">Start</button>
            <button id="howBtn" class="startBtn" style="background:linear-gradient(45deg,#6a11cb,#2575fc)">How to play</button>
          </div>
          <div class="small">Tip: tap letters on mobile or drag them into slots.</div>
        </div>
      </div>

      <!-- Category Selection -->
      <div id="categoryScreen">
        <h2 style="margin-top:0">Choose a category & difficulty</h2>
        <div style="display:flex;gap:12px; margin-bottom:10px; align-items:center; flex-wrap:wrap">
          <select id="catSelect" style="padding:10px;border-radius:12px;border:1px solid #ddd">
            <option value="all">Mixed</option>
            <option value="computer">Computer</option>
            <option value="animals">Animals</option>
            <option value="environment">Environment</option>
          </select>

          <select id="difficulty" style="padding:10px;border-radius:12px;border:1px solid #ddd">
            <option value="easy">Easy (6)</option>
            <option value="medium" selected>Medium (10)</option>
            <option value="hard">Hard (14)</option>
          </select>

          <div class="small">Round length changes with difficulty.</div>
        </div>

        <div class="categoryGrid" id="categoryGrid"></div>
        <div style="text-align:center;margin-top:12px"><button id="catBack" class="startBtn" style="background:linear-gradient(45deg,#f7971e,#ffd200)">Back</button></div>
      </div>

      <!-- Game Area -->
      <div id="gameArea">
        <div class="riddleBar">
          <div id="riddle">Riddle will appear here</div>
          <div class="meta">
            <div id="qCount">Q 0 / 10</div>
            <div class="progress" style="width:160px"><i id="progressFill"></i></div>
            <div id="progressLabel"></div>
            <div id="playerLabel"></div>
          </div>
        </div>

        <div id="answerSlots" aria-live="polite"></div>
        <div id="letters" aria-hidden="false"></div>
        <div id="controls"></div>
        <div id="feedback" role="status"></div>
      </div>

      <!-- Report -->
      <div id="report">
        <h2 id="reportTitle"></h2>
        <div id="scoreSummary" style="display:flex;gap:12px;align-items:center"></div>
        <div id="reportBody"></div>
        <div style="margin-top:12px; display:flex; gap:8px; justify-content:center">
          <button id="playAgainBtn" class="startBtn">Play Again</button>
          <button id="showLB" class="startBtn" style="background:linear-gradient(45deg,#6a11cb,#2575fc)">Leaderboard</button>
        </div>

        <div id="leaderboard">
          <h3>Leaderboard</h3>
          <table id="lbTable"><thead><tr><th>Rank</th><th>Name</th><th>Score %</th><th>Medal</th><th>Date</th></tr></thead><tbody id="lbBody"></tbody></table>
          <div style="text-align:center;margin-top:10px;display:flex;gap:8px;justify-content:center">
            <button id="closeLB" class="startBtn" style="background:linear-gradient(45deg,#f7971e,#ffd200)">Close</button>
            <button id="clearLB" class="startBtn" style="background:linear-gradient(45deg,#ff5f6d,#ffc371)">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- audio -->
  <audio id="bgMusic" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>
  <audio id="correctSound" src="https://www.soundjay.com/misc/sounds/kbc-win-01.mp3"></audio>
  <audio id="wrongSound" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>

  <script>
const riddles={
computer:[
{q:"I have keys but no doors",a:"KEYBOARD",emoji:"‚å®Ô∏è"},
{q:"I have a brain but I am not human",a:"CPU",emoji:"üñ•Ô∏è"},
{q:"I show pictures and text",a:"MONITOR",emoji:"üñ•Ô∏è"},
{q:"I move the cursor",a:"MOUSE",emoji:"üñ±Ô∏è"},
{q:"I keep files when power is off",a:"HARD DISK",emoji:"üíæ"},
{q:"I print documents",a:"PRINTER",emoji:"üñ®Ô∏è"},
{q:"I help you browse the internet",a:"BROWSER",emoji:"üåê"},
{q:"I store programs temporarily",a:"RAM",emoji:"üíæ"},
{q:"I process data",a:"PROCESSOR",emoji:"üñ•Ô∏è"},
{q:"I am used to click links",a:"TOUCHPAD",emoji:"üñ±Ô∏è"},
{q:"I run apps on mobile",a:"OPERATING SYSTEM",emoji:"üì±"},
{q:"I protect computer from viruses",a:"ANTIVIRUS",emoji:"üõ°Ô∏è"},
{q:"I connect computers in network",a:"ROUTER",emoji:"üì°"},
{q:"I display text in command mode",a:"TERMINAL",emoji:"üíª"},
{q:"I am storage that is fast",a:"SSD",emoji:"üíæ"},
{q:"I am the main circuit board",a:"MOTHERBOARD",emoji:"üñ•Ô∏è"},
{q:"I send emails electronically",a:"EMAIL",emoji:"üìß"},
{q:"I take photos digitally",a:"CAMERA",emoji:"üì∑"},
{q:"I hold memory",a:"USB",emoji:"üíæ"},
{q:"I cool the computer",a:"FAN",emoji:"üåÄ"},
{q:"I help design graphics",a:"PHOTOSHOP",emoji:"üé®"},
{q:"I write code",a:"PROGRAMMING",emoji:"üíª"},
{q:"I run calculations",a:"CALCULATOR",emoji:"üßÆ"},
{q:"I connect devices",a:"BLUETOOTH",emoji:"üîµ"},
{q:"I display moving pictures",a:"PROJECTOR",emoji:"üìΩÔ∏è"},
{q:"I type text with fingers",a:"KEYPAD",emoji:"‚å®Ô∏è"},
{q:"I connect to WiFi",a:"MODEM",emoji:"üì°"},
{q:"I watch videos online",a:"YOUTUBE",emoji:"üì∫"},
{q:"I store music",a:"MP3PLAYER",emoji:"üéµ"},
{q:"I write documents",a:"WORD",emoji:"üìÑ"},
{q:"I manage tables",a:"EXCEL",emoji:"üìä"},
{q:"I make presentations",a:"POWERPOINT",emoji:"üìä"},
{q:"I manage database",a:"ACCESS",emoji:"üíΩ"},
{q:"I type fast",a:"TYPING",emoji:"‚å®Ô∏è"},
{q:"I send messages",a:"WHATSAPP",emoji:"üí¨"},
{q:"I edit images",a:"PAINT",emoji:"üñåÔ∏è"},
{q:"I search online",a:"GOOGLE",emoji:"üîç"},
{q:"I store files online",a:"CLOUD",emoji:"‚òÅÔ∏è"},
{q:"I create websites",a:"HTML",emoji:"üåê"},
{q:"I style websites",a:"CSS",emoji:"üé®"},
{q:"I add interactivity",a:"JAVASCRIPT",emoji:"üíª"},
{q:"I convert files",a:"PDF",emoji:"üìÑ"},
{q:"I run presentations",a:"SLIDES",emoji:"üìä"},
{q:"I manage emails",a:"OUTLOOK",emoji:"üìß"},
{q:"I edit videos",a:"PREMIERE",emoji:"üé¨"},
{q:"I code apps",a:"ANDROID",emoji:"ü§ñ"},
{q:"I make AI models",a:"CHATGPT",emoji:"ü§ñ"},
{q:"I store graphics",a:"PHOTOS",emoji:"üñºÔ∏è"},
{q:"I type on phone",a:"KEYBOARD",emoji:"‚å®Ô∏è"},
{q:"I scan barcodes",a:"SCANNER",emoji:"üì†"},
{q:"I measure temperature",a:"THERMOMETER",emoji:"üå°Ô∏è"},
{q:"I control lights remotely",a:"SMARTHOME",emoji:"üè†"}
],
animals:[
{q:"I have a mane and roar loudly",a:"LION",emoji:"ü¶Å"},
{q:"I give milk and say moo",a:"COW",emoji:"üêÑ"},
{q:"I hop and have long ears",a:"RABBIT",emoji:"üêá"},
{q:"I carry my house on my back",a:"TURTLE",emoji:"üê¢"},
{q:"I slither and hiss",a:"SNAKE",emoji:"üêç"},
{q:"I am king of the jungle",a:"TIGER",emoji:"üêØ"},
{q:"I quack and swim",a:"DUCK",emoji:"ü¶Ü"},
{q:"I have black and white stripes",a:"ZEBRA",emoji:"ü¶ì"},
{q:"I have a long trunk",a:"ELEPHANT",emoji:"üêò"},
{q:"I fly at night and use echolocation",a:"BAT",emoji:"ü¶á"},
{q:"I live in water and have fins",a:"FISH",emoji:"üêü"},
{q:"I am slow and carry shell",a:"SNAIL",emoji:"üêå"},
{q:"I have big tusks",a:"MAMMOTH",emoji:"üêò"},
{q:"I have a pouch for babies",a:"KANGAROO",emoji:"ü¶ò"},
{q:"I change colors to hide",a:"CHAMELEON",emoji:"ü¶é"},
{q:"I have feathers and can swim",a:"PENGUIN",emoji:"üêß"},
{q:"I roar under water",a:"HIPPOPOTAMUS",emoji:"ü¶õ"},
{q:"I have a shell and swim",a:"SEA TURTLE",emoji:"üê¢"},
{q:"I have a hump and spit",a:"CAMEL",emoji:"üê´"},
{q:"I have a long neck and spots",a:"GIRAFFE",emoji:"ü¶í"},
{q:"I live in hives and make honey",a:"BEE",emoji:"üêù"},
{q:"I sting and make honey",a:"WASP",emoji:"üêù"},
{q:"I have stripes and sting",a:"BEE",emoji:"üêù"},
{q:"I howl at night",a:"WOLF",emoji:"üê∫"},
{q:"I have a bushy tail",a:"FOX",emoji:"ü¶ä"},
{q:"I am slow and eat leaves",a:"SLOTH",emoji:"ü¶•"},
{q:"I am big and gray",a:"RHINOCEROS",emoji:"ü¶è"},
{q:"I have sharp quills",a:"PORCUPINE",emoji:"ü¶î"},
{q:"I live underground",a:"MOLE",emoji:"üêæ"},
{q:"I make webs",a:"SPIDER",emoji:"üï∑Ô∏è"},
{q:"I am black and live near humans",a:"CAT",emoji:"üêà"},
{q:"I bark loudly",a:"DOG",emoji:"üêï"},
{q:"I hop in ponds",a:"FROG",emoji:"üê∏"},
{q:"I fly and drink nectar",a:"BUTTERFLY",emoji:"ü¶ã"},
{q:"I swim and have a beak",a:"DUCK",emoji:"ü¶Ü"},
{q:"I have antlers",a:"DEER",emoji:"ü¶å"},
{q:"I eat bamboo",a:"PANDA",emoji:"üêº"},
{q:"I fly in night sky",a:"OWL",emoji:"ü¶â"},
{q:"I have a shell",a:"SNAIL",emoji:"üêå"},
{q:"I am red and live in forest",a:"FOX",emoji:"ü¶ä"},
{q:"I jump far",a:"KANGAROO",emoji:"ü¶ò"},
{q:"I am spiny and eat ants",a:"ANTEATER",emoji:"üêú"},
{q:"I am green and live in water",a:"FROG",emoji:"üê∏"},
{q:"I spin silk",a:"SPIDER",emoji:"üï∑Ô∏è"},
{q:"I am colorful and fly",a:"BUTTERFLY",emoji:"ü¶ã"},
{q:"I am tall and eat leaves",a:"GIRAFFE",emoji:"ü¶í"},
{q:"I am strong and carry wood",a:"BEAVER",emoji:"ü¶´"}
],
environment:[
{q:"I am the biggest source of light",a:"SUN",emoji:"‚òÄÔ∏è"},
{q:"I give oxygen to breathe",a:"TREE",emoji:"üå≥"},
{q:"I fall from the sky as drops",a:"RAIN",emoji:"üåßÔ∏è"},
{q:"I blow and make kites fly",a:"WIND",emoji:"üå¨Ô∏è"},
{q:"I cover 70% of the Earth",a:"OCEAN",emoji:"üåä"},
{q:"I protect earth from sun rays",a:"OZONE",emoji:"üõ°Ô∏è"},
{q:"I am frozen water",a:"ICE",emoji:"‚ùÑÔ∏è"},
{q:"I form when clouds become heavy",a:"RAIN",emoji:"üåßÔ∏è"},
{q:"I am bright at night",a:"MOON",emoji:"üåï"},
{q:"I give light during day",a:"SUNLIGHT",emoji:"‚òÄÔ∏è"},
{q:"I am small and live in soil",a:"ANT",emoji:"üêú"},
{q:"I provide wood",a:"TREE",emoji:"üå≥"},
{q:"I am green and grow",a:"PLANT",emoji:"üå±"},
{q:"I block sunlight",a:"CLOUD",emoji:"‚òÅÔ∏è"},
{q:"I fall as frozen rain",a:"SNOW",emoji:"‚ùÑÔ∏è"},
{q:"I am the wettest",a:"RAINY SEASON",emoji:"üåßÔ∏è"},
{q:"I make waves",a:"OCEAN",emoji:"üåä"},
{q:"I am in sky and white",a:"CLOUD",emoji:"‚òÅÔ∏è"},
{q:"I am dry land",a:"DESERT",emoji:"üèúÔ∏è"},
{q:"I produce fruits",a:"TREE",emoji:"üå≥"},
{q:"I turn brown in autumn",a:"LEAF",emoji:"üçÇ"},
{q:"I grow in water",a:"LOTUS",emoji:"üå∏"},
{q:"I spin and move air",a:"FAN",emoji:"üå¨Ô∏è"},
{q:"I am dirty water",a:"MUD",emoji:"üü§"},
{q:"I flow in rivers",a:"WATER",emoji:"üíß"},
{q:"I am tall and green",a:"TREE",emoji:"üå≥"},
{q:"I am full of ice",a:"GLACIER",emoji:"üßä"},
{q:"I provide energy",a:"SUN",emoji:"‚òÄÔ∏è"},
{q:"I grow in fields",a:"CROP",emoji:"üåæ"},
{q:"I am part of earth crust",a:"ROCK",emoji:"ü™®"},
{q:"I give shade",a:"TREE",emoji:"üå≥"},
{q:"I am loud and strong",a:"THUNDER",emoji:"‚ö°"},
{q:"I fall on roofs",a:"RAIN",emoji:"üåßÔ∏è"},
{q:"I am round and orbit earth",a:"MOON",emoji:"üåï"},
{q:"I am wet and green",a:"MOSS",emoji:"üçÉ"},
{q:"I am bright and hot",a:"SUN",emoji:"‚òÄÔ∏è"},
{q:"I provide habitat",a:"FOREST",emoji:"üå≤"},
{q:"I clean air",a:"TREE",emoji:"üå≥"},
{q:"I am source of energy",a:"WIND",emoji:"üå¨Ô∏è"},
{q:"I am frozen and white",a:"SNOW",emoji:"‚ùÑÔ∏è"},
{q:"I am essential for life",a:"WATER",emoji:"üíß"},
{q:"I move in ocean",a:"WAVE",emoji:"üåä"},
{q:"I block pollution",a:"TREE",emoji:"üå≥"},
{q:"I am yellow and round",a:"SUN",emoji:"‚òÄÔ∏è"},
{q:"I am in the sky and twinkle",a:"STAR",emoji:"‚≠ê"}
]
};


  // Game state
  let playerName='Player', musicOn=false, currentCategory='all';
  let roundQuestions=[], answersLog=[], currentIndex=0;
  let ROUND_SIZE=10; // will set from difficulty
  let usedQuestions=new Set(); // Track asked questions
  let hintUsed=0; // per question

  // DOM refs
  const startScreen=document.getElementById('startScreen');
  const categoryScreen=document.getElementById('categoryScreen');
  const categoryGrid=document.getElementById('categoryGrid');
  const gameArea=document.getElementById('gameArea');
  const riddleEl=document.getElementById('riddle');
  const answerSlots=document.getElementById('answerSlots');
  const lettersEl=document.getElementById('letters');
  const controlsEl=document.getElementById('controls');
  const feedbackEl=document.getElementById('feedback');
  const qCountEl=document.getElementById('qCount');
  const progressFill=document.getElementById('progressFill');
  const progressLabel=document.getElementById('progressLabel');
  const playerLabel=document.getElementById('playerLabel');
  const report=document.getElementById('report');
  const reportBody=document.getElementById('reportBody');
  const reportTitle=document.getElementById('reportTitle');
  const scoreSummary=document.getElementById('scoreSummary');
  const playAgainBtn=document.getElementById('playAgainBtn');
  const showLB=document.getElementById('showLB');
  const leaderboard=document.getElementById('leaderboard');
  const lbBody=document.getElementById('lbBody');
  const bgMusic=document.getElementById('bgMusic');
  const musicBtn=document.getElementById('musicBtn');
  const correctSound=document.getElementById('correctSound');
  const wrongSound=document.getElementById('wrongSound');
  const catSelect=document.getElementById('catSelect');
  const difficultySelect=document.getElementById('difficulty');

  document.getElementById('startBtn').addEventListener('click', ()=>{ playerName = (document.getElementById('playerName').value || 'Player').trim() || 'Player'; showCategories(); });
  document.getElementById('howBtn').addEventListener('click', showHow);
  document.getElementById('catBack').addEventListener('click', ()=>{ showStart(); });
  musicBtn.addEventListener('click', toggleMusic);
  playAgainBtn.addEventListener('click', ()=>{ showCategories(); });
  showStart();

  function showHow(){ alert('Drag or tap letters into the slots. Use Hint to reveal up to 2 letters per question. Press Backspace to remove last letter.'); }
  function showCategories(){ startScreen.style.display='none'; report.style.display='none'; categoryScreen.style.display='block'; gameArea.style.display='none'; categoryGrid.innerHTML='';
    // show categories as cards for quick pick
    const cats = ['all','computer','animals','environment'];
    cats.forEach(c=>{ const card=document.createElement('div'); card.className='catCard'; card.innerHTML=`<h3>${capitalize(c)}</h3><p>${c==='all' ? 'Mixed topics' : 'Riddles about '+c}</p>`; card.onclick=()=>{ currentCategory=c; startRoundFromUI(); }; categoryGrid.appendChild(card); });
  }
  function showStart(){ categoryScreen.style.display='none'; startScreen.style.display='flex'; }
  function capitalize(s){ return (s||'').charAt(0).toUpperCase()+s.slice(1); }

  // Utility: dedupe pool by answer (normalized)
  function uniqueByAnswer(pool){ const map = new Map(); pool.forEach(item=>{ const key = (item.a || '').replace(/\s+/g,'').toUpperCase(); if(!map.has(key)) map.set(key, item); }); return Array.from(map.values()); }

  function startRoundFromUI(){
    // set difficulty-based round size
    const diff = (difficultySelect.value || 'medium');
    if(diff==='easy') ROUND_SIZE = 6;
    else if(diff==='hard') ROUND_SIZE = 14;
    else ROUND_SIZE = 10;
    startRound();
  }

  function startRound(){
    let pool = currentCategory==='all' ? [...riddles.computer,...riddles.animals,...riddles.environment] : (riddles[currentCategory] || []);
    pool = uniqueByAnswer(pool);
    let freshPool = pool.filter(q=>!usedQuestions.has((q.a||'').replace(/\s+/g,'')+ '||' + q.q));
    if(freshPool.length < ROUND_SIZE){ usedQuestions.clear(); freshPool = pool.slice(); }
    const shuffled = shuffle(freshPool.slice());
    roundQuestions = shuffled.slice(0, ROUND_SIZE);
    roundQuestions.forEach(q=>usedQuestions.add((q.a||'').replace(/\s+/g,'')+ '||' + q.q));

    answersLog = []; currentIndex=0; report.style.display='none'; categoryScreen.style.display='none'; gameArea.style.display='block'; playerLabel.textContent = playerName; updateProgress(); renderQuestion();
  }

  function renderQuestion(){ clearTimeout(window._nextTimeout); feedbackEl.textContent=''; controlsEl.innerHTML=''; answerSlots.innerHTML=''; lettersEl.innerHTML=''; hintUsed=0;
    const q = roundQuestions[currentIndex]; qCountEl.textContent = `Q ${currentIndex+1} / ${ROUND_SIZE}`; riddleEl.textContent = q.emoji + ' ' + q.q;
    const answer = q.a; const clean = answer.replace(/\s+/g,'');
    // Build slots
    for(let i=0;i<clean.length;i++){ const s=document.createElement('div'); s.className='slot'; s.dataset.pos = i; s.dataset.tileId = ''; s.ondrop = drop; s.ondragover = allowDrop; s.onclick = slotClick; s.setAttribute('aria-label','letter slot'); answerSlots.appendChild(s); }

    // Build tiles ‚Äî keep duplicates by creating a tile per letter instance
    const lettersArr = clean.split('');
    const shuffledLetters = shuffle(lettersArr.slice());
    shuffledLetters.forEach((L, idx)=>{ const t=document.createElement('div'); t.className='tile'; t.textContent=L; t.id='tile_'+idx+'_'+Date.now()+Math.floor(Math.random()*1000); t.draggable=true; t.setAttribute('role','button'); t.ondragstart=dragStart; t.onclick = ()=>tileClick(t); t.style.background = `hsl(${Math.random()*360},70%,85%)`; lettersEl.appendChild(t); });

    const resetBtn=document.createElement('button'); resetBtn.textContent='Reset'; resetBtn.onclick=clearAnswer; controlsEl.appendChild(resetBtn);
    const skipBtn=document.createElement('button'); skipBtn.textContent='Skip'; skipBtn.onclick=()=>handleSkip(); controlsEl.appendChild(skipBtn);
    const hintBtn=document.createElement('button'); hintBtn.textContent='Hint (2)'; hintBtn.onclick=()=>useHint(hintBtn); controlsEl.appendChild(hintBtn);

    updateProgress();
  }

  function useHint(btn){ if(hintUsed>=2) return; const q=roundQuestions[currentIndex]; const clean = q.a.replace(/\s+/g,''); const slots = Array.from(document.querySelectorAll('.slot'));
    const emptySlots = slots.filter((s)=>!s.textContent);
    if(emptySlots.length===0) return;
    let targetIdx = -1;
    if(hintUsed===0){ for(let i=0;i<clean.length;i++){ const s = slots.find(ss=>Number(ss.dataset.pos)===i); if(s && !s.textContent){ targetIdx = i; break; } } } else { for(let i=clean.length-1;i>=0;i--){ const s = slots.find(ss=>Number(ss.dataset.pos)===i); if(s && !s.textContent){ targetIdx = i; break; } } }
    if(targetIdx===-1){ const randSlot = emptySlots[Math.floor(Math.random()*emptySlots.length)]; targetIdx = Number(randSlot.dataset.pos); }
    const slot = slots.find(s=>Number(s.dataset.pos)===targetIdx); if(!slot) return; const letter = clean[targetIdx];
    const tile = Array.from(document.querySelectorAll('.tile')).find(t=>t.textContent===letter && t.style.visibility!=='hidden');
    slot.textContent = letter; slot.dataset.tileId = tile ? tile.id : ''; if(tile) tile.style.visibility='hidden'; hintUsed++; btn.textContent=`Hint (${2-hintUsed})`; if(hintUsed>=2) btn.disabled=true; checkAutoAnswer(); }

  function dragStart(ev){ ev.dataTransfer.setData('text/plain', ev.target.id); }
  function allowDrop(ev){ ev.preventDefault(); }
  function drop(ev){ ev.preventDefault(); const id = ev.dataTransfer.getData('text'); const tile = document.getElementById(id); if(!tile) return; const target = ev.target; if(target.classList.contains('slot')){ if(target.textContent===''){ target.textContent = tile.textContent; target.dataset.tileId = tile.id; tile.style.visibility='hidden'; checkAutoAnswer(); } else { const oldId = target.dataset.tileId; if(oldId){ const oldTile = document.getElementById(oldId); if(oldTile) oldTile.style.visibility='visible'; } target.textContent = tile.textContent; target.dataset.tileId = tile.id; tile.style.visibility='hidden'; checkAutoAnswer(); } } }

  // when a tile is clicked/tapped, place it in first empty slot
  function tileClick(tile){ if(tile.style.visibility==='hidden') return; const empty = Array.from(document.querySelectorAll('.slot')).find(s=>s.textContent===''); if(empty){ empty.textContent = tile.textContent; empty.dataset.tileId = tile.id; tile.style.visibility='hidden'; checkAutoAnswer(); } }

  // when slot is clicked, clear it and restore the tile (if any)
  function slotClick(ev){ const slot = ev.currentTarget || ev.target; const tid = slot.dataset.tileId; if(!slot.textContent) return; slot.textContent = ''; slot.dataset.tileId = ''; if(tid){ const tile = document.getElementById(tid); if(tile) tile.style.visibility = 'visible'; } }

  function clearAnswer(){ document.querySelectorAll('.slot').forEach(s=>{ s.textContent=''; s.dataset.tileId=''; }); document.querySelectorAll('.tile').forEach(t=>t.style.visibility='visible'); feedbackEl.textContent=''; }

  function getUserAnswer(){ const slots = Array.from(document.querySelectorAll('.slot')).sort((a,b)=> Number(a.dataset.pos) - Number(b.dataset.pos)); return slots.map(s=>s.textContent || '').join(''); }

  function checkAutoAnswer(){ const q=roundQuestions[currentIndex]; const clean=q.a.replace(/\s+/g,''); const user=getUserAnswer(); if(user.length===clean.length){ if(user.toUpperCase()===clean.toUpperCase()){ handleCorrect(); } else { showCorrectNow(); } } }

  function handleCorrect(){ answersLog.push({q:roundQuestions[currentIndex].q, a:roundQuestions[currentIndex].a, correct:true, skipped:false}); feedbackEl.textContent='‚úÖ Correct!'; try{ correctSound.play(); }catch(e){} showConfetti(); updateProgress(); window._nextTimeout=setTimeout(()=>{ currentIndex++; if(currentIndex>=ROUND_SIZE) endRound(); else renderQuestion(); }, 900); }

  function showCorrectNow(){ const q=roundQuestions[currentIndex]; const correct=q.a.replace(/\s+/g,''); const slots=Array.from(document.querySelectorAll('.slot'));
    slots.forEach(s=>{ const idx = Number(s.dataset.pos); s.textContent = correct[idx] || ''; s.dataset.tileId = ''; }); document.querySelectorAll('.tile').forEach(t=>t.style.visibility='hidden'); feedbackEl.textContent='‚ùå Oops! Answer: '+q.a; try{ wrongSound.play(); }catch(e){} answersLog.push({q:q.q, a:q.a, correct:false, skipped:false}); updateProgress(); window._nextTimeout=setTimeout(()=>{ currentIndex++; if(currentIndex>=ROUND_SIZE) endRound(); else renderQuestion(); }, 1500); }

  function handleSkip(){ const q=roundQuestions[currentIndex]; const correct=q.a.replace(/\s+/g,''); const slots=Array.from(document.querySelectorAll('.slot'));
    slots.forEach(s=>{ const idx = Number(s.dataset.pos); s.textContent = correct[idx] || ''; s.dataset.tileId = ''; }); document.querySelectorAll('.tile').forEach(t=>t.style.visibility='hidden'); feedbackEl.textContent='‚è≠Ô∏è Skipped! Answer: '+q.a; try{ wrongSound.play(); }catch(e){} answersLog.push({q:q.q, a:q.a, correct:false, skipped:true}); updateProgress(); window._nextTimeout=setTimeout(()=>{ currentIndex++; if(currentIndex>=ROUND_SIZE) endRound(); else renderQuestion(); }, 1500); }

  function updateProgress(){ const answered = answersLog.length; progressFill.style.width = ((answered/ROUND_SIZE)*100)+'%'; progressLabel.textContent = `${answered}/${ROUND_SIZE} answered`; qCountEl.textContent = `Q ${Math.min(currentIndex+1, ROUND_SIZE)} / ${ROUND_SIZE}`; }

  function endRound(){ gameArea.style.display='none'; report.style.display='block'; leaderboard.style.display='none';
    const correctCount = answersLog.filter(x=>x.correct).length; const scorePercent = Math.round((correctCount/ROUND_SIZE)*100);
    reportTitle.textContent = `Report for ${playerName}`;
    // Medal logic
    let medal = '';
    if(scorePercent >= 90) medal = 'ü•á';
    else if(scorePercent >= 75) medal = 'ü•à';
    else if(scorePercent >= 50) medal = 'ü•â';

    // Star logic (simple)
    let stars = '‚≠ê'.repeat(Math.min(5, Math.ceil(scorePercent/20)));

    scoreSummary.innerHTML = `\n      <div style="font-size:20px">Score: ${correctCount}/${ROUND_SIZE} (${scorePercent}%)</div>\n      ${medal ? `<div class="medal">${medal}</div>` : ''}\n      <div style="font-size:24px;color:#f4d03f">${stars}</div>\n    `;

    // Detailed table
    let html = '<table><thead><tr><th>Q</th><th>Riddle</th><th>Your Result</th></tr></thead><tbody>';
    answersLog.forEach((x,i)=>{ const res = x.correct ? '‚úÖ Correct' : (x.skipped ? '‚è≠Ô∏è Skipped' : '‚ùå Wrong'); html += `<tr><td>${i+1}</td><td>${x.q}</td><td>${res} (Ans: ${x.a})</td></tr>`; });
    html += '</tbody></table>';
    reportBody.innerHTML = html;

    saveScore({name: playerName, score: scorePercent, medal});
  }

  showLB.addEventListener('click', ()=>{ leaderboard.style.display='block'; renderLB(); });
  document.getElementById('closeLB').addEventListener('click', ()=>{ leaderboard.style.display='none'; });
  document.getElementById('clearLB').addEventListener('click', ()=>{ if(confirm('Clear leaderboard?')){ localStorage.removeItem('riddleScores'); renderLB(); } });

  function saveScore(entry){ let list=JSON.parse(localStorage.getItem('riddleScores')||'[]'); entry.date = new Date().toLocaleString(); list.push(entry); // keep latest 200
    list = list.slice(-200); localStorage.setItem('riddleScores', JSON.stringify(list)); }

  function renderLB(){ let list = JSON.parse(localStorage.getItem('riddleScores') || '[]'); // sort by score desc then date desc
    list = list.sort((a,b)=> { if(b.score!==a.score) return b.score - a.score; return new Date(b.date) - new Date(a.date); }).slice(0,10);
    lbBody.innerHTML = ''; list.forEach((x,i)=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(x.name)}</td><td>${x.score}%</td><td>${x.medal||''}</td><td>${x.date||''}</td>`; lbBody.appendChild(tr); }); }

  // simple html-escape to avoid injection if name contains "<"
  function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function showConfetti(){ const count=16; for(let i=0;i<count;i++){ const conf=document.createElement('div'); conf.style.position='fixed'; conf.style.top='-10px'; conf.style.left=(Math.random()*100)+'%'; conf.style.width='10px'; conf.style.height='10px'; conf.style.background=`hsl(${Math.random()*360},100%,50%)`; conf.style.borderRadius='50%'; conf.style.opacity='0.9'; conf.style.zIndex=9999; conf.style.pointerEvents='none'; conf.animate([{transform:'translateY(0)','opacity':1},{transform:'translateY(100vh)','opacity':0}], {duration:Math.random()*1200+800, easing:'ease-out'}); document.body.appendChild(conf); setTimeout(()=>conf.remove(),1800); } }

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

  function toggleMusic(){ if(musicOn){ bgMusic.pause(); musicBtn.textContent='üéµ'; } else { bgMusic.play().catch(()=>{}); musicBtn.textContent='üîá'; } musicOn=!musicOn; }

  // Keyboard support: letters place matching visible tile, Backspace removes last filled slot
  document.addEventListener('keydown',(e)=>{
    if(gameArea.style.display==='block'){
      const key = e.key;
      if(key==='Backspace'){ e.preventDefault(); // clear last filled slot
        const filled = Array.from(document.querySelectorAll('.slot')).filter(s=>s.textContent); if(filled.length){ const last = filled[filled.length-1]; const tid = last.dataset.tileId; last.textContent=''; last.dataset.tileId=''; if(tid){ const tile = document.getElementById(tid); if(tile) tile.style.visibility='visible'; } }
      } else if(/^[a-zA-Z]$/.test(key)){
        const letter = key.toUpperCase(); const tile = Array.from(document.querySelectorAll('.tile')).find(t=>t.textContent===letter && t.style.visibility!=='hidden'); if(tile){ tileClick(tile); }
      }
    }
  });

  </script>
</body>
</html>


